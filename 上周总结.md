#### Django 框架的会话管理

##### 服务的有状态和无状态

- 对服务器程序来说，究竟是有状态服务，还是无状态服务，其判断依旧——**两个来自相同发起者的请求在服务器端是否具备上下文关系。**
- **有状态服务是有凭证的**
- **总结** : 
  - 有状态服务可以比较容易地实现事务，在不需要考虑水平扩展时，是比较好的选择 
    无状态服务的优势在于可以很方便地水平伸缩，但是在实现事务时，需要做一些额外的动作 
    可以通过剥离session等方法，将一个有状态服务，转换成无状态服务 

##### HTTP协议中的状态

- 标准的http协议是 **无状态的，无连接的**
- **无连接指的是什么** :
  - 1. 每一个访问都是无连接，服务器挨个处理访问队列里的访问，处理完一个就关闭连接，这事儿就完了，然后处理下一个新的
  -    2 . 无连接的含义是限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接
- **无状态** : 
  - 1. 协议对于事务处理没有记忆能力【事物处理】【记忆能力】
  - 2. 对同一个url请求没有上下文关系【上下文关系】
  - 3. 每次的请求都是独立的，它的执行情况和结果与前面的请求和之后的请求是无直接关系的，它不会受前面的请求应答情况直接影响，也不会直接影响后面的请求应答情况【无直接联系】【受直接影响】
  - 4. 服务器中没有保存客户端的状态，客户端必须每次带上自己的状态去请求服务器【状态】
- **解决方案**
  - cookie session 机制
    - **cookie 与 session 的区别** : 
      - 1. Cookie 数据存放在客户的浏览器上，Session 数据放在服务器上
      - 2. Cookie 不是很安全，别人可以分析存放在本地的COOKIE并进行COOKIE欺骗，考虑到安全应当使用 Session
      - 3. Session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能。考虑到减轻服务器性能方面，应当使用COOKIE

##### 小程序中的状态

- **小程序中的有状态服务**
  - 小程序不能直接与后台进行数据的交换
  - 小程序要与后台发生交互需要通过**微信服务器**作为转发进行交互

- **小程序中如何获取 Cookie** 
  - <img src="image/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%8E%B7%E5%8F%96cookie.png" style="zoom:50%;" />

- **Django的Session中间件**

  - django session 默认的过期时间为 14天

  - 保存在服务器上的键值对

  - 设置 session 

    - ```python
      request.session['key'] = value
      ```

    - django内部自动生成随机的字符串

    - 在 django_session 表中存入数据

    - 将产生的随机字符串发送给浏览器 让浏览器保存到cookie中（sessionid:随机字符串）

  - 获取session

    - ```python
      request.session.get('key')
      ```

    - 浏览器发送cookie到django后端之后 django会自动获取到cookie值
    - 拿着随机字符串去django_session表中比对 是否有对应的数据
    - 如果比对上了 就讲随机字符串所对应的数据 取出赋值给`request.session`,如果对不上 那么`request.session`就是空
    - **`session`表中的一条记录针对一个浏览器，同一台电脑上，不同的浏览器来，才会有不同的记录**

  - 删除session

    - **delete** : 删除服务端的
    - **flush** : 浏览器和服务端全部删除

##### 用户体系

- 自建用户体系
  - 邮箱 , 电话等**标记用户**
- 沿用微信用户体系
  - 使用别人写好的用户体系
  - openid **用户唯一的标识**
- 区别:
  - 自建用户体系(**缺点**) ---- 填写 , 去重等复杂的交互逻辑

##### 小程序获取用户的 openid 

- ​	![](image/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%8E%B7%E5%8F%96openid%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg)

  - 1. 小程序先去访问微信服务器  --->code

  - 2. 小程序发送code   --->  Django后台

  - 3. Django后台携带 code , appid , appsercetkey  ---> 微信服务器

  - 4. 返回给 Django后台  openid , sessionid

  - 5. 进行存储 后 返回给小程序端 cookie进行保存

  - 6. 小程序端携带cookie 请求Django后台

  - 7. Django后台进行 cookie 与 session 对比

    

